<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirDrop Web</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: #ffffff;
            --text-color: #1d1d1f;
            --secondary-text-color: #86868b;
            --border-color: #d2d2d7;
            --accent-color: #007aff;
            --accent-color-hover: #0071e3;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #161616;
                --card-bg-color: #1e1e1e;
                --text-color: #f5f5f7;
                --secondary-text-color: #8d8d92;
                --border-color: #3a3a3c;
                --accent-color: #0a84ff;
                --accent-color-hover: #007aff;
                --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }
        }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 520px; display: flex; flex-direction: column; gap: 24px; }
        .card { background-color: var(--card-bg-color); border-radius: 18px; padding: 24px; box-shadow: var(--card-shadow); transition: background-color 0.3s, box-shadow 0.3s; }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .card-header svg { width: 24px; height: 24px; fill: var(--secondary-text-color); }
        .card-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        #clipboard { width: 100%; min-height: 120px; border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; font-size: 1rem; font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); resize: vertical; box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; overflow-y: auto; }
        #clipboard:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); }
        #clipboard:empty:before { content: "在此处粘贴文本或图片..."; color: var(--secondary-text-color); cursor: text; }
        #clipboard img { max-width: 100%; border-radius: 8px; cursor: pointer; }
        .file-transfer-area { display: flex; flex-direction: column; gap: 16px; }
        .file-drop-zone { border: 2px dashed var(--border-color); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: border-color 0.3s, background-color 0.3s; }
        .file-drop-zone.drag-over { border-color: var(--accent-color); background-color: rgba(0, 122, 255, 0.05); }
        .file-drop-zone svg { width: 48px; height: 48px; fill: var(--accent-color); margin-bottom: 8px; }
        .file-drop-zone p { margin: 0; color: var(--secondary-text-color); font-size: 0.9rem; }
        .file-drop-zone p strong { color: var(--accent-color); }
        #file-input { display: none; }
        .device-select-wrapper { display: flex; align-items: center; gap: 12px; }
        #target-device-select { flex-grow: 1; padding: 12px 16px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 12px; background-color: var(--bg-color); color: var(--text-color); appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M5%208l5%205%205-5z%22%20fill%3D%22%2386868b%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 16px center; background-size: 16px; cursor: pointer; }
        #send-file-btn { padding: 12px 20px; font-size: 1rem; font-weight: 500; color: #fff; background-color: var(--accent-color); border: none; border-radius: 12px; cursor: pointer; transition: background-color 0.2s ease-in-out; }
        #send-file-btn:hover { background-color: var(--accent-color-hover); }
        #send-file-btn:disabled { background-color: var(--secondary-text-color); cursor: not-allowed; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 12px 24px; border-radius: 25px; font-size: 0.9rem; font-weight: 500; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, bottom 0.3s ease; }
        #toast.show { opacity: 1; visibility: visible; bottom: 50px; }

        .status-bar { position: fixed; top: 20px; right: 20px; background-color: var(--card-bg-color); padding: 8px 16px; border-radius: 12px; box-shadow: var(--card-shadow); font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 12px; /* 增加间距 */ }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #34c759; flex-shrink: 0; }
        
        #address-container { position: relative; }
        #info-icon { font-size: 1.1rem; color: var(--secondary-text-color); cursor: pointer; user-select: none; }
        #address-tooltip { position: absolute; top: 140%; right: 0; background-color: #333; color: #fff; padding: 8px 12px; border-radius: 8px; white-space: nowrap; font-size: 0.85rem; font-weight: 400; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s ease; z-index: 10; }
        #address-tooltip::after { content: ''; position: absolute; bottom: 100%; right: 10px; border-width: 5px; border-style: solid; border-color: transparent transparent #333 transparent; }
        #address-tooltip.show { opacity: 1; visibility: visible; transform: translateY(0); }
    </style>
</head>
<body>

    <div class="status-bar">
        <span class="status-dot"></span>
        <span id="current-device-name">连接中...</span>
        <div id="address-container">
            <span id="info-icon">ⓘ</span>
            <div id="address-tooltip"></div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <svg xmlns="http://www.w.org/2000/svg" viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0S9.6.84 9.18 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                <h2>共享剪贴板</h2>
            </div>
            <div id="clipboard" contenteditable="true"></div>
        </div>
        <div class="card">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
                <h2>文件传输</h2>
            </div>
            <div class="file-transfer-area">
                <label for="file-input" id="file-drop-zone" class="file-drop-zone">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                    <p>拖拽文件到此处，或<strong>点击选择</strong></p>
                    <p id="file-name-display" style="margin-top: 8px; font-weight: 500;"></p>
                </label>
                <input type="file" id="file-input">
                <div class="device-select-wrapper">
                    <select id="target-device-select"><option value="">选择接收设备</option></select>
                    <button id="send-file-btn" disabled>发送</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // DOM Elements
        const clipboard = document.getElementById('clipboard');
        const fileInput = document.getElementById('file-input');
        const targetDeviceSelect = document.getElementById('target-device-select');
        const sendFileBtn = document.getElementById('send-file-btn');
        const currentDeviceName = document.getElementById('current-device-name');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileNameDisplay = document.getElementById('file-name-display');
        const toast = document.getElementById('toast');
        const addressContainer = document.getElementById('address-container');
        const infoIcon = document.getElementById('info-icon');
        const addressTooltip = document.getElementById('address-tooltip');

        let currentDeviceId = '';

        // 页面加载后立即设置提示内容
        addressTooltip.textContent = `在其他设备上访问: ${window.location.origin}`;
        
        // 点击图标时显示/隐藏提示
        infoIcon.addEventListener('click', (event) => {
            event.stopPropagation(); // 防止事件冒泡到 window
            addressTooltip.classList.toggle('show');
        });

        // 点击页面其他任何地方隐藏提示
        window.addEventListener('click', () => {
            if (addressTooltip.classList.contains('show')) {
                addressTooltip.classList.remove('show');
            }
        });

        // --- Device Info and List ---
        socket.on('device-info', (device) => { currentDeviceId = device.id; currentDeviceName.textContent = `本机: ${device.name}`; });
        socket.on('update-devices', (devices) => {
            const hasDevices = devices.some(d => d.id !== currentDeviceId);
            targetDeviceSelect.innerHTML = hasDevices ? '' : '<option value="">没有其他设备在线</option>';
            devices.forEach(device => {
                if (device.id !== currentDeviceId) {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.name;
                    targetDeviceSelect.appendChild(option);
                }
            });
            updateSendButtonState();
        });

        // --- Clipboard Sync ---
        function showToast(message) { toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
        async function handleImageCopy(base64Url) {
            if (navigator.clipboard && navigator.clipboard.write && window.isSecureContext) {
                try {
                    const response = await fetch(base64Url);
                    const blob = await response.blob();
                    await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
                    showToast('图片已复制到剪贴板！');
                } catch (error) { console.error('Clipboard API write failed:', error); openImageInNewTab(base64Url); }
            } else { openImageInNewTab(base64Url); }
        }
        function openImageInNewTab(base64Url) {
            const newTab = window.open();
            if (newTab) {
                newTab.document.write(`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>共享图片 (请长按复制)</title><style>body { margin: 0; background-color: #202124; display: flex; justify-content: center; align-items: center; min-height: 100vh; } img { max-width: 100%; max-height: 100vh; object-fit: contain; }</style></head><body><img src="${base64Url}" alt="共享图片"></body></html>`);
                newTab.document.close();
                showToast('已在新标签页中打开图片，请长按复制');
            } else { showToast('无法打开新标签页，请检查浏览器弹窗设置'); }
        }
        clipboard.addEventListener('click', (event) => { if (event.target.tagName === 'IMG') { handleImageCopy(event.target.src); } });
        clipboard.addEventListener('paste', (event) => {
            event.preventDefault();
            const items = (event.clipboardData || window.clipboardData).items;
            let imageFound = false;
            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Image = e.target.result;
                        clipboard.innerHTML = `<img src="${base64Image}" alt="共享图片" title="点击即可复制图片">`;
                        socket.emit('text-change', base64Image);
                    };
                    reader.readAsDataURL(blob);
                    imageFound = true;
                    break;
                }
            }
            if (!imageFound) { const text = (event.clipboardData || window.clipboardData).getData('text/plain'); document.execCommand('insertText', false, text); }
        });
        clipboard.addEventListener('input', () => { if (document.activeElement === clipboard) { socket.emit('text-change', clipboard.innerHTML); } });
        socket.on('text-update', (data) => {
            if (document.activeElement !== clipboard) {
                if (data.startsWith('data:image/')) { clipboard.innerHTML = `<img src="${data}" alt="共享图片" title="点击即可复制图片">`; } else { clipboard.innerHTML = data; }
            }
        });

        // --- File Transfer ---
        function updateSendButtonState() { const fileSelected = fileInput.files.length > 0; const deviceSelected = targetDeviceSelect.value !== ''; sendFileBtn.disabled = !(fileSelected && deviceSelected); }
        fileInput.addEventListener('change', () => { fileNameDisplay.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : ''; updateSendButtonState(); });
        targetDeviceSelect.addEventListener('change', updateSendButtonState);
        fileDropZone.addEventListener('dragover', (e) => { e.preventDefault(); fileDropZone.classList.add('drag-over'); });
        fileDropZone.addEventListener('dragleave', () => { fileDropZone.classList.remove('drag-over'); });
        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) { fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change')); }
        });
        sendFileBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            const targetDevice = targetDeviceSelect.value;
            if (!file || !targetDevice) { alert('请选择文件和目标设备'); return; }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('targetDevice', targetDevice);
            sendFileBtn.textContent = '发送中...';
            sendFileBtn.disabled = true;
            fetch('/upload', { method: 'POST', body: formData })
            .then(response => response.text())
            .then(result => { alert(result); fileInput.value = ''; fileNameDisplay.textContent = ''; sendFileBtn.textContent = '发送'; updateSendButtonState(); })
            .catch(error => { console.error('Error:', error); alert('文件发送失败'); sendFileBtn.textContent = '发送'; updateSendButtonState(); });
        });
        socket.on('file-notification', ({ fileName, fileSize, downloadUrl }) => {
            const sizeInMB = (fileSize / 1024 / 1024).toFixed(2);
            if (confirm(`收到文件 "${fileName}" (${sizeInMB} MB)，是否下载？`)) {
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    </script>
</body>
</html>